# 进程间通信微架构实现提案

## 概述

实现一个基于共享内存的进程间通信（IPC）微架构，负责在收到内存管道信息后自动派发和处理数据。该架构采用环形队列设计，通过异步线程监视共享内存的读写指针状态，实现高效的数据交换。

## 动机

当前项目需要支持跨进程通信机制，用于：
- 主服务进程与外部客户端进程的数据交换
- 异步指令派发与处理
- 高吞吐量的内存级数据传输

通过共享内存方式可以避免传统 IPC 方式（如管道、套接字）的数据拷贝开销，显著提升通信效率。

## 目标

1. **实现 ShareMemoryMgr**：统一管理指令和数据两块共享内存的初始化和生命周期
2. **完善 ShareMemoryCommandMgr**：实现指令共享内存的读写操作，支持环形队列机制
3. **完善 SharedMemoryDateManager**：实现数据共享内存的读写操作
4. **实现 CommadChanelMgr**：通过异步线程监视共享内存管道，检测读写指针差异并触发读取
5. **定义 DispatchMgr 接口**：建立指令派发机制的基础接口框架

## 非目标

- 不实现 DispatchMgr 的具体业务派发逻辑（仅定义接口）
- 不添加对外暴露的新接口，严格遵循现有头文件定义
- 不修改现有的数据结构和内存布局定义

## 技术方案

### 架构组件

```
┌─────────────────────────────────────────────────────────────┐
│                    CommadChanelMgr                          │
│  ┌──────────────┐         ┌──────────────────────────────┐  │
│  │  Listener    │────────▶│   BatchReadCommands()        │  │
│  │  Thread      │         │   - 检测 reqWrite != reqRead │  │
│  │  (异步)      │         │   - 批量读取指令             │  │
│  └──────────────┘         └──────────────┬───────────────┘  │
└──────────────────────────────────────────┼──────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    DispatchMgr                              │
│              DispatchCommand(CommandBlock)                  │
│                    (接口定义)                               │
└─────────────────────────────────────────────────────────────┘
                           ▲
                           │
┌──────────────────────────┴──────────────────────────────────┐
│                    ShareMemoryMgr                           │
│  ┌─────────────────────┐    ┌─────────────────────────────┐ │
│  │ ShareMemoryCommandMgr│    │ SharedMemoryDateManager     │ │
│  │ - 指令环形队列       │    │ - 数据环形队列              │ │
│  │ - reqWrite/reqRead   │    │ - respWrite/respRead        │ │
│  └─────────────────────┘    └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 核心机制

1. **追击设计（环形队列）**：
   - 写指针 (`reqWrite`) 追读指针 (`reqRead`)
   - 当 `reqWrite == reqRead` 时，表示无新数据
   - 当 `reqWrite != reqRead` 时，表示有待读取数据

2. **异步监视机制**：
   - CommadChanelMgr 启动独立监听线程
   - 线程循环检测读写指针状态
   - 检测到数据时批量读取并派发

3. **双通道设计**：
   - 指令通道 (Command)：用于传输控制指令
   - 数据通道 (Date)：用于传输业务数据

## 相关文件

- `ShareMemoryMgr.h` - 共享内存管理器接口
- `ShareMemoryCommandMgr.h` - 指令共享内存管理器接口
- `SharedMemoryDateManager.h` - 数据共享内存管理器接口
- `CommadChanelMgr.h` - 命令通道管理器接口
- `DispatchMgr.h` - 派发管理器接口
- `ShareMonyDate.h` - 共享内存数据结构定义
- `CommandEnem.h` - 指令类型枚举
- `Message.h` - 消息封装类

## 成功标准

- [ ] ShareMemoryMgr 正确初始化和销毁两块共享内存
- [ ] ShareMemoryCommandMgr 实现完整的读写功能
- [ ] SharedMemoryDateManager 实现完整的读写功能
- [ ] CommadChanelMgr 异步线程正确监视并触发读取
- [ ] DispatchMgr 接口定义完整，可被后续实现使用
- [ ] 不添加任何头文件未定义的对外接口
